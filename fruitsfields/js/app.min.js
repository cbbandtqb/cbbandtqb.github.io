const chrX=56,chrY=56,roomX=18,roomY=12,dispX=chrX*roomX,dispY=chrY*(roomY+0),chr=["","wall","down","left","right","up","fruits","player"];var game={data:{fruits:0,roomNo:0,room:[],solution:""},onload:function(){me.video.init(dispX,dispY,{parent:"screen",scale:"auto",scaleMethod:"fit"})?(me.game.viewport=new me.Camera2d(0,0,dispX,dispY),me.loader.preload(game.resources,this.loaded.bind(this)),me.loader.preload([{name:"PressStart2P",type:"binary",src:"data/fnt/PressStart2P.fnt"},{name:"PressStart2P",type:"image",src:"data/fnt/PressStart2P.png"},{name:"room",type:"json",src:"data/room/room.json"}])):alert("Your browser does not support HTML5 canvas.")},loaded:function(){me.state.set(me.state.MENU,new game.TitleScreen),me.state.set(me.state.PLAY,new game.PlayScreen),me.input.bindKey(me.input.KEY.X,"click",!0),me.input.bindPointer(me.input.KEY.X),me.input.bindKey(me.input.KEY.ESC,"escape",!0),game.data.room=me.loader.getJSON("room"),me.state.change(me.state.MENU)},resources:[{name:"100",type:"image",src:"data/img/100.png"},{name:"down",type:"image",src:"data/img/down.png"},{name:"fruits",type:"image",src:"data/img/fruits.png"},{name:"left",type:"image",src:"data/img/left.png"},{name:"player",type:"image",src:"data/img/player.png"},{name:"right",type:"image",src:"data/img/right.png"},{name:"title",type:"image",src:"data/img/title.png"},{name:"title_bg",type:"image",src:"data/img/title_bg.png"},{name:"up",type:"image",src:"data/img/up.png"},{name:"wall",type:"image",src:"data/img/wall.png"}]};game.HUD=game.HUD||{},game.HUD.Container=me.Container.extend({init:function(){me.Container.prototype.init.apply(this),this.isPersistent=!0,this.floating=!0,this.name="HUD",this.addChild(new game.HUD.ScoreItem(5,5))}}),game.HUD.ScoreItem=me.Renderable.extend({init:function(e,r){me.Renderable.prototype.init.apply(this,[e,r,10,10]),this.score=-1},update:function(){return this.score!==game.data.score&&(this.score=game.data.score,!0)},draw:function(e){}}),game.PlayerEntity=me.Entity.extend({init:function(e,r,t){me.Entity.prototype.init.apply(this,[e,r,t])},update:function(e){return this.body.update(e),me.collision.check(this),me.Entity.prototype.update.apply(this,[e])||0!==this.body.vel.x||0!==this.body.vel.y},onCollision:function(e,r){return!0}});const MANUAL=0,AUTOMATIC=1,SHAKE_INTENSITY=10,SHAKE_DURATION=300,OBSTACLE=1e4;var getPlayerPos=function(e){var r=new Object;for(y=0;y<12;y++)for(x=0;x<18;x++)if(7==e[y][x])return r.x=x,r.y=y,r},paint=function(e,r,t,a){var i,o,s=[];for(s.push([r,t]),e[t][r]=a;0<s.length;)i=(o=s.shift())[0],0==e[(o=o[1])+1][i]&&(s.push([i,o+1]),e[o+1][i]=a),0==e[o][i-1]&&(s.push([i-1,o]),e[o][i-1]=a),0==e[o-1][i]&&(s.push([i,o-1]),e[o-1][i]=a),0==e[o][i+1]&&(s.push([i+1,o]),e[o][i+1]=a)},isAbleToMovePlayer=function(e,r,t){for(var a=[],i=0;i<12;i++){a[i]=[];for(var o=0;o<18;o++)a[i][o]=e[i][o]}var s=getPlayerPos(e);return paint(a,s.x,s.y,7),7==a[t][r]},measure=function(e,r,t,a){return e<t?r<a?t-e+a-r:t-e+r-a:r<a?e-t+a-r:e-t+r-a},navigate=function(e,r,t,a,i){for(var o=[],s=0;s<12;s++){o[s]=[];for(var m=0;m<18;m++)0!=e[s][m]&&7!=e[s][m]?o[s][m]=OBSTACLE:o[s][m]=0}var n=[];for(n.push([a,i,1]),o[i][a]=1;0<n.length;){var h=n.shift(),p=h[0],c=h[1],l=h[2];0==o[c+1][p]&&(n.push([p,c+1,l+1]),o[c+1][p]=l+1),0==o[c][p-1]&&(n.push([p-1,c,l+1]),o[c][p-1]=l+1),0==o[c-1][p]&&(n.push([p,c-1,l+1]),o[c-1][p]=l+1),0==o[c][p+1]&&(n.push([p+1,c,l+1]),o[c][p+1]=l+1)}var d=[],p=r,l=o[c=t][p];for(o[c][p]=OBSTACLE,d.push([p,c]);1<l;){var g=p,y=c+1;(l=o[y][g])>o[c][p-1]&&(g=p-1,l=o[y=c][g]),l>o[c-1][p]&&(g=p,l=o[y=c-1][g]),l>o[c][p+1]&&(g=p+1,l=o[y=c][g]),p=g,o[c=y][p]=OBSTACLE,d.push([p,c])}return d};game.PlayScreen=me.Stage.extend({onResetEvent:function(){var g=MANUAL;me.game.world.addChild(new me.ColorLayer("bg",new me.Color(197,166,136),0)),this.HUD=new game.HUD.Container,me.game.world.addChild(this.HUD);for(var y=[],e=game.data.fruits=0;e<roomY;e++){y[e]=[];for(var r=0;r<roomX;r++)y[e][r]=game.data.room[game.data.roomNo][e][r],6==y[e][r]&&game.data.fruits++}for(var u=[],t=0,e=0;e<roomY;e++){u[e]=[];for(r=0;r<roomX;r++)0!=y[e][r]&&(u[e][r]=new me.Sprite(r*chrX+chrX/2,e*chrY+chrY/2,{image:chr[y[e][r]],name:t++}),me.game.world.addChild(u[e][r]))}me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height])},update:function(e){var r,t,a,i,o,s;me.input.isKeyPressed("escape")&&me.state.change(me.state.MENU);var m,n,h=-1,p=-1;if(g==MANUAL&&me.input.isKeyPressed("click")&&(n=me.input.globalToLocal(me.input.pointer.clientX,me.input.pointer.clientY),h=parseInt(n.x/chrX),p=parseInt(n.y/chrY)),AUTOMATIC,-1==h||-1==p)return!0;switch(y[p][h]){case 0:if(isAbleToMovePlayer(y,h,p)){o=getPlayerPos(y),s=navigate(y,o.x,o.y,h,p);for(var c=0;c<s.length;c++){var l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[p][h]=7,u[p][h]=u[o.y][o.x],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[o.y][o.x]=0}else me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH);break;case 1:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH);break;case 2:switch(y[p+1][h]){case 0:case 7:if(t=r=-1,m=1/0,o=getPlayerPos(y),0!=y[p-1][h]&&7!=y[p-1][h]||!isAbleToMovePlayer(y,h,p-1)||(r=h,t=p-1,m=measure(o.x,o.y,r,t)),(0==y[p][h-1]||7==y[p][h-1])&&isAbleToMovePlayer(y,h-1,p)&&m>measure(o.x,o.y,h-1,p)&&(r=h-1,t=p,m=measure(o.x,o.y,r,t)),(0==y[p][h+1]||7==y[p][h+1])&&isAbleToMovePlayer(y,h+1,p)&&m>measure(o.x,o.y,h+1,p)&&(r=h+1,t=p),-1==r||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}for(y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,(s=[]).push([a=h,i=p]);0==y[i+1][a]||7==y[i+1][a];)i++,s.push([a,i]);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,2,c))}y[i][a]=2,u[i][a]=u[p][h],u[i][a].pos.x=a*chrX+chrX/2,u[i][a].pos.y=i*chrY+chrY/2,y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 1:case 2:case 3:case 4:case 6:if(0!=y[p-1][h]&&7!=y[p-1][h]||!isAbleToMovePlayer(y,h,p-1))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;r=h,t=p-1,o=getPlayerPos(y),s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,me.game.world.removeChild(u[p][h]),y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 5:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 3:switch(y[p][h-1]){case 0:case 7:if(t=r=-1,m=1/0,o=getPlayerPos(y),0!=y[p][h+1]&&7!=y[p][h+1]||!isAbleToMovePlayer(y,h+1,p)||(r=h+1,t=p,m=measure(o.x,o.y,r,t)),(0==y[p-1][h]||7==y[p-1][h])&&isAbleToMovePlayer(y,h,p-1)&&m>measure(o.x,o.y,h,p-1)&&(r=h,t=p-1,m=measure(o.x,o.y,r,t)),(0==y[p+1][h]||7==y[p+1][h])&&isAbleToMovePlayer(y,h,p+1)&&m>measure(o.x,o.y,h,p+1)&&(r=h,t=p+1),-1==r||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}for(y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,(s=[]).push([a=h,i=p]);0==y[i][a-1]||7==y[i][a-1];)--a,s.push([a,i]);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,3,c))}y[i][a]=3,u[i][a]=u[p][h],u[i][a].pos.x=a*chrX+chrX/2,u[i][a].pos.y=i*chrY+chrY/2,y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 1:case 2:case 3:case 5:case 6:if(0!=y[p][h+1]&&7!=y[p][h+1]||!isAbleToMovePlayer(y,h+1,p))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;r=h+1,t=p,o=getPlayerPos(y),s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,me.game.world.removeChild(u[p][h]),y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 4:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 4:switch(y[p][h+1]){case 0:case 7:if(t=r=-1,m=1/0,o=getPlayerPos(y),0!=y[p][h-1]&&7!=y[p][h-1]||!isAbleToMovePlayer(y,h-1,p)||(r=h-1,t=p,m=measure(o.x,o.y,r,t)),(0==y[p+1][h]||7==y[p+1][h])&&isAbleToMovePlayer(y,h,p+1)&&m>measure(o.x,o.y,h,p+1)&&(r=h,t=p+1,m=measure(o.x,o.y,r,t)),(0==y[p-1][h]||7==y[p-1][h])&&isAbleToMovePlayer(y,h,p-1)&&m>measure(o.x,o.y,h,p-1)&&(r=h,t=p-1),-1==r||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}for(y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,(s=[]).push([a=h,i=p]);0==y[i][a+1]||7==y[i][a+1];)a++,s.push([a,i]);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,4,c))}y[i][a]=4,u[i][a]=u[p][h],u[i][a].pos.x=a*chrX+chrX/2,u[i][a].pos.y=i*chrY+chrY/2,y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 1:case 2:case 4:case 5:case 6:if(0!=y[p][h-1]&&7!=y[p][h-1]||!isAbleToMovePlayer(y,h-1,p))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;r=h-1,t=p,o=getPlayerPos(y),s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,me.game.world.removeChild(u[p][h]),y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 3:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 5:switch(y[p-1][h]){case 0:case 7:if(t=r=-1,m=1/0,o=getPlayerPos(y),0!=y[p+1][h]&&7!=y[p+1][h]||!isAbleToMovePlayer(y,h,p+1)||(r=h,t=p+1,m=measure(o.x,o.y,r,t)),(0==y[p][h+1]||7==y[p][h+1])&&isAbleToMovePlayer(y,h+1,p)&&m>measure(o.x,o.y,h+1,p)&&(r=h+1,t=p,m=measure(o.x,o.y,r,t)),(0==y[p][h-1]||7==y[p][h-1])&&isAbleToMovePlayer(y,h-1,p)&&m>measure(o.x,o.y,h-1,p)&&(r=h-1,t=p),-1==r||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}for(y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,(s=[]).push([a=h,i=p]);0==y[i-1][a]||7==y[i-1][a];)--i,s.push([a,i]);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,5,c))}y[i][a]=5,u[i][a]=u[p][h],u[i][a].pos.x=a*chrX+chrX/2,u[i][a].pos.y=i*chrY+chrY/2,y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 1:case 3:case 4:case 5:case 6:if(0!=y[p+1][h]&&7!=y[p+1][h]||!isAbleToMovePlayer(y,h,p+1))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;r=h,t=p+1,o=getPlayerPos(y),s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,me.game.world.removeChild(u[p][h]),y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0;break;case 2:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 6:if(t=r=-1,m=1/0,o=getPlayerPos(y),0!=y[p+1][h]&&7!=y[p+1][h]||!isAbleToMovePlayer(y,h,p+1)||(r=h,t=p+1,m=measure(o.x,o.y,r,t)),(0==y[p][h-1]||7==y[p][h-1])&&isAbleToMovePlayer(y,h-1,p)&&m>measure(o.x,o.y,h-1,p)&&(r=h-1,t=p,m=measure(o.x,o.y,r,t)),(0==y[p-1][h]||7==y[p-1][h])&&isAbleToMovePlayer(y,h,p-1)&&m>measure(o.x,o.y,h,p-1)&&(r=h,t=p-1,m=measure(o.x,o.y,r,t)),(0==y[p][h+1]||7==y[p][h+1])&&isAbleToMovePlayer(y,h+1,p)&&m>measure(o.x,o.y,h+1,p)&&(r=h+1,t=p),-1==r||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;s=navigate(y,o.x,o.y,r,t);for(c=0;c<s.length;c++){l=s[c][0],d=s[c][1];me.game.world.addChild(new MovingSprite(l,d,7,c))}y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,y[t][r]=7,u[t][r]=u[o.y][o.x],u[t][r].pos.x=r*chrX+chrX/2,u[t][r].pos.y=t*chrY+chrY/2,y[o.y][o.x]=0,me.game.world.removeChild(u[p][h]),me.game.world.addChild(new StretchingSprite(h,p,6)),y[p][h]=7,u[p][h]=u[t][r],u[p][h].pos.x=h*chrX+chrX/2,u[p][h].pos.y=p*chrY+chrY/2,y[t][r]=0,--game.data.fruits,0==game.data.fruits&&me.state.change(me.state.MENU)}return!0},draw:function(e){},onDestroyEvent:function(){}})),3)},onDestroyEvent:function(){me.game.world.removeChild(this.HUD)}}),MovingSprite=me.Sprite.extend({init:function(e,r,t,a){me.Sprite.prototype.init.apply(this,[e*chrX+chrX/2,r*chrY+chrY/2,{image:chr[t]}]),this.tm=1+a/10,this.itv=0},update:function(e){return this.itv+=e,this.itv<100||(this.itv=0,this.tm-=.25,this.tm<1&&(this.tm<0&&(this.tm=0),this.alpha=this.tm),this.tm<=0&&me.game.world.removeChild(this)),!0}}),StretchingSprite=me.Sprite.extend({init:function(e,r,t){me.Sprite.prototype.init.apply(this,[e*chrX+chrX/2,r*chrY+chrY/2,{image:chr[t]}]),this.tm=4,this.itv=0,this.by=this.pos.y},update:function(e){return this.itv+=e,this.itv<100||(this.itv=0,this.tm-=.2,this.pos.y=this.by+(this.tm-2)*(this.tm-2)*chrY*3/4-3*chrY,this.tm<1&&(this.tm<0&&(this.tm=0),this.alpha=this.tm),this.tm<=0&&me.game.world.removeChild(this)),!0}}),Solution=me.Renderable.extend({init:function(e,r,t,a){switch(me.Renderable.prototype.init.apply(this,[e,r,100,100]),this.$input=$('<input type="'+t+'" required>').css({left:e,top:r,width:a}),t){case"text":this.$input.attr("maxlength",a).attr("pattern","[a-zA-Z0-9_-]+");break;case"number":this.$input.attr("max",a)}$(me.video.getParent()).append(this.$input)},update:function(e){return game.data.solution=this.$input.val(),!0},destroy:function(){this.$input.remove()}});const sx=72,sy=30;game.TitleScreen=me.Stage.extend({onResetEvent:function(){me.game.world.addChild(new me.ColorLayer("bg",new me.Color(197,166,136),0)),me.game.world.addChild(new me.Sprite(dispX/2,dispY/4,{image:"title_bg"})),me.game.world.addChild(new me.Sprite(dispX/2,dispY/4,{image:"title"})),me.game.world.addChild(new me.Sprite(dispX/2,3*dispY/4,{image:"100"})),me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height]),this.font=new me.BitmapText(1,1,{font:"PressStart2P",size:1})},update:function(e){var r;return me.input.isKeyPressed("click")&&(r=me.input.globalToLocal(me.input.pointer.clientX,me.input.pointer.clientY),rx=Math.floor((r.x-(dispX/2-5*sx))/sx),ry=Math.floor((r.y-(3*dispY/4-5*sy))/sy),0<=rx&&rx<10&&0<=ry&&ry<10&&(game.data.roomNo=10*ry+rx,me.state.change(me.state.PLAY))),!0},onDestroyEvent:function(){}})),3)},onDestroyEvent:function(){}});