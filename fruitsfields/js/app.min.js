const chrX=56,chrY=56,roomX=18,roomY=12,dispX=chrX*roomX,dispY=chrY*(roomY+0),chr=["","wall","down","left","right","up","fruits","player"];var game={data:{fruits:0,roomNo:0,room:[],solution:""},onload:function(){me.video.init(dispX,dispY,{parent:"screen",scale:"auto",scaleMethod:"fit"})?(me.game.viewport=new me.Camera2d(0,0,dispX,dispY),me.loader.preload(game.resources,this.loaded.bind(this)),me.loader.preload([{name:"PressStart2P",type:"binary",src:"data/fnt/PressStart2P.fnt"},{name:"PressStart2P",type:"image",src:"data/fnt/PressStart2P.png"},{name:"room",type:"json",src:"data/room/room.json"}])):alert("Your browser does not support HTML5 canvas.")},loaded:function(){me.state.set(me.state.MENU,new game.TitleScreen),me.state.set(me.state.PLAY,new game.PlayScreen),me.input.bindKey(me.input.KEY.X,"click",!0),me.input.bindPointer(me.input.KEY.X),me.input.bindKey(me.input.KEY.ESC,"escape",!0),game.data.room=me.loader.getJSON("room"),me.state.change(me.state.MENU)},resources:[{name:"00",type:"image",src:"data/img/00.png"},{name:"01",type:"image",src:"data/img/01.png"},{name:"02",type:"image",src:"data/img/02.png"},{name:"03",type:"image",src:"data/img/03.png"},{name:"04",type:"image",src:"data/img/04.png"},{name:"05",type:"image",src:"data/img/05.png"},{name:"06",type:"image",src:"data/img/06.png"},{name:"07",type:"image",src:"data/img/07.png"},{name:"08",type:"image",src:"data/img/08.png"},{name:"09",type:"image",src:"data/img/09.png"},{name:"10",type:"image",src:"data/img/10.png"},{name:"11",type:"image",src:"data/img/11.png"},{name:"12",type:"image",src:"data/img/12.png"},{name:"13",type:"image",src:"data/img/13.png"},{name:"14",type:"image",src:"data/img/14.png"},{name:"15",type:"image",src:"data/img/15.png"},{name:"16",type:"image",src:"data/img/16.png"},{name:"17",type:"image",src:"data/img/17.png"},{name:"18",type:"image",src:"data/img/18.png"},{name:"19",type:"image",src:"data/img/19.png"},{name:"20",type:"image",src:"data/img/20.png"},{name:"21",type:"image",src:"data/img/21.png"},{name:"22",type:"image",src:"data/img/22.png"},{name:"23",type:"image",src:"data/img/23.png"},{name:"24",type:"image",src:"data/img/24.png"},{name:"25",type:"image",src:"data/img/25.png"},{name:"26",type:"image",src:"data/img/26.png"},{name:"27",type:"image",src:"data/img/27.png"},{name:"28",type:"image",src:"data/img/28.png"},{name:"29",type:"image",src:"data/img/29.png"},{name:"30",type:"image",src:"data/img/30.png"},{name:"31",type:"image",src:"data/img/31.png"},{name:"32",type:"image",src:"data/img/32.png"},{name:"33",type:"image",src:"data/img/33.png"},{name:"34",type:"image",src:"data/img/34.png"},{name:"35",type:"image",src:"data/img/35.png"},{name:"36",type:"image",src:"data/img/36.png"},{name:"37",type:"image",src:"data/img/37.png"},{name:"38",type:"image",src:"data/img/38.png"},{name:"39",type:"image",src:"data/img/39.png"},{name:"40",type:"image",src:"data/img/40.png"},{name:"41",type:"image",src:"data/img/41.png"},{name:"42",type:"image",src:"data/img/42.png"},{name:"43",type:"image",src:"data/img/43.png"},{name:"44",type:"image",src:"data/img/44.png"},{name:"45",type:"image",src:"data/img/45.png"},{name:"46",type:"image",src:"data/img/46.png"},{name:"47",type:"image",src:"data/img/47.png"},{name:"48",type:"image",src:"data/img/48.png"},{name:"49",type:"image",src:"data/img/49.png"},{name:"50",type:"image",src:"data/img/50.png"},{name:"51",type:"image",src:"data/img/51.png"},{name:"52",type:"image",src:"data/img/52.png"},{name:"53",type:"image",src:"data/img/53.png"},{name:"54",type:"image",src:"data/img/54.png"},{name:"55",type:"image",src:"data/img/55.png"},{name:"56",type:"image",src:"data/img/56.png"},{name:"57",type:"image",src:"data/img/57.png"},{name:"58",type:"image",src:"data/img/58.png"},{name:"59",type:"image",src:"data/img/59.png"},{name:"60",type:"image",src:"data/img/60.png"},{name:"61",type:"image",src:"data/img/61.png"},{name:"62",type:"image",src:"data/img/62.png"},{name:"63",type:"image",src:"data/img/63.png"},{name:"64",type:"image",src:"data/img/64.png"},{name:"65",type:"image",src:"data/img/65.png"},{name:"66",type:"image",src:"data/img/66.png"},{name:"67",type:"image",src:"data/img/67.png"},{name:"68",type:"image",src:"data/img/68.png"},{name:"69",type:"image",src:"data/img/69.png"},{name:"70",type:"image",src:"data/img/70.png"},{name:"71",type:"image",src:"data/img/71.png"},{name:"72",type:"image",src:"data/img/72.png"},{name:"73",type:"image",src:"data/img/73.png"},{name:"74",type:"image",src:"data/img/74.png"},{name:"75",type:"image",src:"data/img/75.png"},{name:"76",type:"image",src:"data/img/76.png"},{name:"77",type:"image",src:"data/img/77.png"},{name:"78",type:"image",src:"data/img/78.png"},{name:"79",type:"image",src:"data/img/79.png"},{name:"80",type:"image",src:"data/img/80.png"},{name:"81",type:"image",src:"data/img/81.png"},{name:"82",type:"image",src:"data/img/82.png"},{name:"83",type:"image",src:"data/img/83.png"},{name:"84",type:"image",src:"data/img/84.png"},{name:"85",type:"image",src:"data/img/85.png"},{name:"86",type:"image",src:"data/img/86.png"},{name:"87",type:"image",src:"data/img/87.png"},{name:"88",type:"image",src:"data/img/88.png"},{name:"89",type:"image",src:"data/img/89.png"},{name:"90",type:"image",src:"data/img/90.png"},{name:"91",type:"image",src:"data/img/91.png"},{name:"92",type:"image",src:"data/img/92.png"},{name:"93",type:"image",src:"data/img/93.png"},{name:"94",type:"image",src:"data/img/94.png"},{name:"95",type:"image",src:"data/img/95.png"},{name:"96",type:"image",src:"data/img/96.png"},{name:"97",type:"image",src:"data/img/97.png"},{name:"98",type:"image",src:"data/img/98.png"},{name:"99",type:"image",src:"data/img/99.png"},{name:"down",type:"image",src:"data/img/down.png"},{name:"fruits",type:"image",src:"data/img/fruits.png"},{name:"left",type:"image",src:"data/img/left.png"},{name:"player",type:"image",src:"data/img/player.png"},{name:"right",type:"image",src:"data/img/right.png"},{name:"title",type:"image",src:"data/img/title.png"},{name:"title_bg",type:"image",src:"data/img/title_bg.png"},{name:"up",type:"image",src:"data/img/up.png"},{name:"wall",type:"image",src:"data/img/wall.png"}]};game.HUD=game.HUD||{},game.HUD.Container=me.Container.extend({init:function(){me.Container.prototype.init.apply(this),this.isPersistent=!0,this.floating=!0,this.name="HUD",this.addChild(new game.HUD.ScoreItem(5,5))}}),game.HUD.ScoreItem=me.Renderable.extend({init:function(e,a){me.Renderable.prototype.init.apply(this,[e,a,10,10]),this.score=-1},update:function(){return this.score!==game.data.score&&(this.score=game.data.score,!0)},draw:function(e){}}),game.PlayerEntity=me.Entity.extend({init:function(e,a,t){me.Entity.prototype.init.apply(this,[e,a,t])},update:function(e){return this.body.update(e),me.collision.check(this),me.Entity.prototype.update.apply(this,[e])||0!==this.body.vel.x||0!==this.body.vel.y},onCollision:function(e,a){return!0}});const MANUAL=0,AUTOMATIC=1,SHAKE_INTENSITY=10,SHAKE_DURATION=300,OBSTACLE=1e4;var getPlayerPos=function(e){var a=new Object;for(y=0;y<12;y++)for(x=0;x<18;x++)if(7==e[y][x])return a.x=x,a.y=y,a},paint=function(e,a,t,i){var r,m,n=[];for(n.push([a,t]),e[t][a]=i;0<n.length;)r=(m=n.shift())[0],0==e[(m=m[1])+1][r]&&(n.push([r,m+1]),e[m+1][r]=i),0==e[m][r-1]&&(n.push([r-1,m]),e[m][r-1]=i),0==e[m-1][r]&&(n.push([r,m-1]),e[m-1][r]=i),0==e[m][r+1]&&(n.push([r+1,m]),e[m][r+1]=i)},isAbleToMovePlayer=function(e,a,t){for(var i=[],r=0;r<12;r++){i[r]=[];for(var m=0;m<18;m++)i[r][m]=e[r][m]}var n=getPlayerPos(e);return paint(i,n.x,n.y,7),7==i[t][a]},measure=function(e,a,t,i){return e<t?a<i?t-e+i-a:t-e+a-i:a<i?e-t+i-a:e-t+a-i},navigate=function(e,a,t,i,r){for(var m=[],n=0;n<12;n++){m[n]=[];for(var g=0;g<18;g++)0!=e[n][g]&&7!=e[n][g]?m[n][g]=OBSTACLE:m[n][g]=0}var s=[];for(s.push([i,r,1]),m[r][i]=1;0<s.length;){var p=s.shift(),o=p[0],c=p[1],d=p[2];0==m[c+1][o]&&(s.push([o,c+1,d+1]),m[c+1][o]=d+1),0==m[c][o-1]&&(s.push([o-1,c,d+1]),m[c][o-1]=d+1),0==m[c-1][o]&&(s.push([o,c-1,d+1]),m[c-1][o]=d+1),0==m[c][o+1]&&(s.push([o+1,c,d+1]),m[c][o+1]=d+1)}console.log("skel="),console.log(m);var h=[],o=a,d=m[c=t][o];for(m[c][o]=OBSTACLE,h.push([o,c]);1<d;){var y=o,l=c+1;(d=m[l][y])>m[c][o-1]&&(y=o-1,d=m[l=c][y]),d>m[c-1][o]&&(y=o,d=m[l=c-1][y]),d>m[c][o+1]&&(y=o+1,d=m[l=c][y]),o=y,m[c=l][o]=OBSTACLE,h.push([o,c])}return console.log("route="),console.log(h),h};game.PlayScreen=me.Stage.extend({onResetEvent:function(){var y=MANUAL;me.game.world.addChild(new me.ColorLayer("bg",new me.Color(197,166,136),0)),this.HUD=new game.HUD.Container,me.game.world.addChild(this.HUD);for(var l=[],e=game.data.fruits=0;e<roomY;e++){l[e]=[];for(var a=0;a<roomX;a++)l[e][a]=game.data.room[game.data.roomNo][e][a],6==l[e][a]&&game.data.fruits++}console.log(">>>"),console.log(l);for(var u=[],t=0,e=0;e<roomY;e++){u[e]=[];for(a=0;a<roomX;a++)0!=l[e][a]&&(u[e][a]=new me.Sprite(a*chrX+chrX/2,e*chrY+chrY/2,{image:chr[l[e][a]],name:t++}),me.game.world.addChild(u[e][a]))}me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height])},update:function(e){var a,t,i,r,m,n;me.input.isKeyPressed("escape")&&(console.log(game.data.solution),me.state.change(me.state.MENU));var g,s,p=-1,o=-1;if(y==MANUAL&&me.input.isKeyPressed("click")&&(console.log("Click!"),s=me.input.globalToLocal(me.input.pointer.clientX,me.input.pointer.clientY),p=parseInt(s.x/chrX),o=parseInt(s.y/chrY),console.log("cx="+p+" cy="+o)),AUTOMATIC,-1==p||-1==o)return!0;switch(l[o][p]){case 0:if(isAbleToMovePlayer(l,p,o)){m=getPlayerPos(l),n=navigate(l,m.x,m.y,p,o);for(var c=0;c<n.length;c++){var d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[o][p]=7,u[o][p]=u[m.y][m.x],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[m.y][m.x]=0}else me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH);break;case 1:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH);break;case 2:switch(l[o+1][p]){case 0:case 7:if(t=a=-1,g=1/0,m=getPlayerPos(l),0!=l[o-1][p]&&7!=l[o-1][p]||!isAbleToMovePlayer(l,p,o-1)||(a=p,t=o-1,g=measure(m.x,m.y,a,t)),(0==l[o][p-1]||7==l[o][p-1])&&isAbleToMovePlayer(l,p-1,o)&&g>measure(m.x,m.y,p-1,o)&&(a=p-1,t=o,g=measure(m.x,m.y,a,t)),(0==l[o][p+1]||7==l[o][p+1])&&isAbleToMovePlayer(l,p+1,o)&&g>measure(m.x,m.y,p+1,o)&&(a=p+1,t=o),-1==a||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}for(l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,(n=[]).push([i=p,r=o]);0==l[r+1][i]||7==l[r+1][i];)r++,n.push([i,r]);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,2,c))}l[r][i]=2,u[r][i]=u[o][p],u[r][i].pos.x=i*chrX+chrX/2,u[r][i].pos.y=r*chrY+chrY/2,l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 1:case 2:case 3:case 4:case 6:if(0!=l[o-1][p]&&7!=l[o-1][p]||!isAbleToMovePlayer(l,p,o-1))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;a=p,t=o-1,m=getPlayerPos(l),n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,me.game.world.removeChild(u[o][p]),l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 5:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 3:switch(l[o][p-1]){case 0:case 7:if(t=a=-1,g=1/0,m=getPlayerPos(l),0!=l[o][p+1]&&7!=l[o][p+1]||!isAbleToMovePlayer(l,p+1,o)||(a=p+1,t=o,g=measure(m.x,m.y,a,t)),(0==l[o-1][p]||7==l[o-1][p])&&isAbleToMovePlayer(l,p,o-1)&&g>measure(m.x,m.y,p,o-1)&&(a=p,t=o-1,g=measure(m.x,m.y,a,t)),(0==l[o+1][p]||7==l[o+1][p])&&isAbleToMovePlayer(l,p,o+1)&&g>measure(m.x,m.y,p,o+1)&&(a=p,t=o+1),-1==a||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}for(l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,(n=[]).push([i=p,r=o]);0==l[r][i-1]||7==l[r][i-1];)--i,n.push([i,r]);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,3,c))}l[r][i]=3,u[r][i]=u[o][p],u[r][i].pos.x=i*chrX+chrX/2,u[r][i].pos.y=r*chrY+chrY/2,l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 1:case 2:case 3:case 5:case 6:if(0!=l[o][p+1]&&7!=l[o][p+1]||!isAbleToMovePlayer(l,p+1,o))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;a=p+1,t=o,m=getPlayerPos(l),n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,me.game.world.removeChild(u[o][p]),l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 4:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 4:switch(l[o][p+1]){case 0:case 7:if(t=a=-1,g=1/0,m=getPlayerPos(l),0!=l[o][p-1]&&7!=l[o][p-1]||!isAbleToMovePlayer(l,p-1,o)||(a=p-1,t=o,g=measure(m.x,m.y,a,t)),(0==l[o+1][p]||7==l[o+1][p])&&isAbleToMovePlayer(l,p,o+1)&&g>measure(m.x,m.y,p,o+1)&&(a=p,t=o+1,g=measure(m.x,m.y,a,t)),(0==l[o-1][p]||7==l[o-1][p])&&isAbleToMovePlayer(l,p,o-1)&&g>measure(m.x,m.y,p,o-1)&&(a=p,t=o-1),-1==a||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}for(l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,(n=[]).push([i=p,r=o]);0==l[r][i+1]||7==l[r][i+1];)i++,n.push([i,r]);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,4,c))}l[r][i]=4,u[r][i]=u[o][p],u[r][i].pos.x=i*chrX+chrX/2,u[r][i].pos.y=r*chrY+chrY/2,l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 1:case 2:case 4:case 5:case 6:if(0!=l[o][p-1]&&7!=l[o][p-1]||!isAbleToMovePlayer(l,p-1,o))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;a=p-1,t=o,m=getPlayerPos(l),n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,me.game.world.removeChild(u[o][p]),l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 3:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 5:switch(l[o-1][p]){case 0:case 7:if(t=a=-1,g=1/0,m=getPlayerPos(l),0!=l[o+1][p]&&7!=l[o+1][p]||!isAbleToMovePlayer(l,p,o+1)||(a=p,t=o+1,g=measure(m.x,m.y,a,t)),(0==l[o][p+1]||7==l[o][p+1])&&isAbleToMovePlayer(l,p+1,o)&&g>measure(m.x,m.y,p+1,o)&&(a=p+1,t=o,g=measure(m.x,m.y,a,t)),(0==l[o][p-1]||7==l[o][p-1])&&isAbleToMovePlayer(l,p-1,o)&&g>measure(m.x,m.y,p-1,o)&&(a=p-1,t=o),-1==a||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}for(l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,(n=[]).push([i=p,r=o]);0==l[r-1][i]||7==l[r-1][i];)--r,n.push([i,r]);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,5,c))}l[r][i]=5,u[r][i]=u[o][p],u[r][i].pos.x=i*chrX+chrX/2,u[r][i].pos.y=r*chrY+chrY/2,l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 1:case 3:case 4:case 5:case 6:if(0!=l[o+1][p]&&7!=l[o+1][p]||!isAbleToMovePlayer(l,p,o+1))return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;a=p,t=o+1,m=getPlayerPos(l),n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,me.game.world.removeChild(u[o][p]),l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0;break;case 2:me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH)}break;case 6:if(t=a=-1,g=1/0,m=getPlayerPos(l),0!=l[o+1][p]&&7!=l[o+1][p]||!isAbleToMovePlayer(l,p,o+1)||(a=p,t=o+1,g=measure(m.x,m.y,a,t)),(0==l[o][p-1]||7==l[o][p-1])&&isAbleToMovePlayer(l,p-1,o)&&g>measure(m.x,m.y,p-1,o)&&(a=p-1,t=o,g=measure(m.x,m.y,a,t)),(0==l[o-1][p]||7==l[o-1][p])&&isAbleToMovePlayer(l,p,o-1)&&g>measure(m.x,m.y,p,o-1)&&(a=p,t=o-1,g=measure(m.x,m.y,a,t)),(0==l[o][p+1]||7==l[o][p+1])&&isAbleToMovePlayer(l,p+1,o)&&g>measure(m.x,m.y,p+1,o)&&(a=p+1,t=o),-1==a||-1==t)return me.game.viewport.shake(SHAKE_INTENSITY,SHAKE_DURATION,me.game.viewport.AXIS.BOTH),!0;n=navigate(l,m.x,m.y,a,t);for(c=0;c<n.length;c++){d=n[c][0],h=n[c][1];me.game.world.addChild(new MovingSprite(d,h,7,c))}l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,l[t][a]=7,u[t][a]=u[m.y][m.x],u[t][a].pos.x=a*chrX+chrX/2,u[t][a].pos.y=t*chrY+chrY/2,l[m.y][m.x]=0,me.game.world.removeChild(u[o][p]),me.game.world.addChild(new StretchingSprite(p,o,6)),l[o][p]=7,u[o][p]=u[t][a],u[o][p].pos.x=p*chrX+chrX/2,u[o][p].pos.y=o*chrY+chrY/2,l[t][a]=0,--game.data.fruits,0==game.data.fruits&&me.state.change(me.state.MENU)}return!0},draw:function(e){},onDestroyEvent:function(){}})),3)},onDestroyEvent:function(){me.game.world.removeChild(this.HUD)}}),MovingSprite=me.Sprite.extend({init:function(e,a,t,i){me.Sprite.prototype.init.apply(this,[e*chrX+chrX/2,a*chrY+chrY/2,{image:chr[t]}]),this.tm=1+i/10,this.itv=0},update:function(e){return this.itv+=e,this.itv<100||(this.itv=0,this.tm-=.25,this.tm<1&&(this.tm<0&&(this.tm=0),this.alpha=this.tm),this.tm<=0&&me.game.world.removeChild(this)),!0}}),StretchingSprite=me.Sprite.extend({init:function(e,a,t){me.Sprite.prototype.init.apply(this,[e*chrX+chrX/2,a*chrY+chrY/2,{image:chr[t]}]),this.tm=1,this.itv=0},update:function(e){return this.itv+=e,this.itv<100||(this.itv=0,this.tm-=.2,this.tm<1&&(this.tm<0&&(this.tm=0),this.alpha=this.tm,this.scale(2-0*this.tm)),this.tm<=0&&me.game.world.removeChild(this)),!0}}),Solution=me.Renderable.extend({init:function(e,a,t,i){switch(me.Renderable.prototype.init.apply(this,[e,a,100,100]),this.$input=$('<input type="'+t+'" required>').css({left:e,top:a,width:i}),t){case"text":this.$input.attr("maxlength",i).attr("pattern","[a-zA-Z0-9_-]+");break;case"number":this.$input.attr("max",i)}$(me.video.getParent()).append(this.$input)},update:function(e){return game.data.solution=this.$input.val(),!0},destroy:function(){this.$input.remove()}}),game.TitleScreen=me.Stage.extend({onResetEvent:function(){me.game.world.addChild(new me.ColorLayer("bg",new me.Color(197,166,136),0)),me.game.world.addChild(new me.Sprite(dispX/2,dispY/4,{image:"title_bg"})),me.game.world.addChild(new me.Sprite(dispX/2,dispY/4,{image:"title"}));for(var t,e=new Array(100),i=0;i<10;i++)for(var r=0;r<10;r++)t=0==i?"0"+r:""+(10*i+r),e[10*i+r]=new(me.Sprite.extend({init:function(e,a){me.Sprite.prototype.init.apply(this,[dispX/2+146*(r-4.5)*.5,5*dispY/7+102*(i-4.5)*.3,{image:t,name:t}]),this.scale(.5,.3)}})),me.game.world.addChild(e[10*i+r]);me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height]),this.font=new me.BitmapText(1,1,{font:"PressStart2P",size:1})},update:function(e){var a;return me.input.isKeyPressed("click")&&(a=me.input.globalToLocal(me.input.pointer.clientX,me.input.pointer.clientY),r=parseInt((a.x-(dispX/2-365))/146/.5),i=parseInt((a.y-(5*dispY/7-153))/102/.3),0<=r&&r<10&&0<=i&&i<10&&(game.data.roomNo=10*i+r,console.log("click "+game.data.roomNo),me.state.change(me.state.PLAY))),!0},draw:function(e){},onDestroyEvent:function(){}})),3)},onDestroyEvent:function(){}});